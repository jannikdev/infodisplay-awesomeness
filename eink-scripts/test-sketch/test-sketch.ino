#include <AsyncTCP.h>
#include <WiFi.h>

#include <GxEPD.h>

#include <GxGDEW075T8/GxGDEW075T8.h>      // 7.5" b/w
//#include <GxGDEW075Z09/GxGDEW075Z09.h>    // 7.5" b/w/r
//#include <GxGDEW075Z08/GxGDEW075Z08.h>    // 7.5" b/w/r 800x480
#include <Fonts/FreeMonoBold9pt7b.h>
#include <Fonts/FreeMonoBold12pt7b.h>
#include <Fonts/FreeMonoBold18pt7b.h>
#include <Fonts/FreeMonoBold24pt7b.h>

#include <GxIO/GxIO_SPI/GxIO_SPI.h>
#include <GxIO/GxIO.h>

#if defined(ESP8266)

// for SPI pin definitions see e.g.:
// C:\Users\xxx\AppData\Local\Arduino15\packages\esp8266\hardware\esp8266\2.4.2\variants\generic\common.h

GxIO_Class io(SPI, /*CS=D8*/ SS, /*DC=D3*/ 0, /*RST=D4*/ 2); // arbitrary selection of D3(=0), D4(=2), selected for default of GxEPD_Class
GxEPD_Class display(io, /*RST=D4*/ 2, /*BUSY=D2*/ 4); // default selection of D4(=2), D2(=4)
// Heltec E-Paper 1.54" b/w without RST, BUSY
//GxEPD_Class display(io, /*RST=D4*/ -1, /*BUSY=D2*/ -1); // no RST, no BUSY

#elif defined(ESP32)

// for SPI pin definitions see e.g.:
// C:\Users\xxx\Documents\Arduino\hardware\espressif\esp32\variants\lolin32\pins_arduino.h

GxIO_Class io(SPI, /*CS=5*/ SS, /*DC=*/ 17, /*RST=*/ 16); // arbitrary selection of 17, 16
GxEPD_Class display(io, /*RST=*/ 16, /*BUSY=*/ 4); // arbitrary selection of (16), 4

#else

// for SPI pin definitions see e.g.:
// C:\Users\xxx\AppData\Local\Arduino15\packages\arduino\hardware\avr\1.6.21\variants\standard\pins_arduino.h

GxIO_Class io(SPI, /*CS=*/ SS, /*DC=*/ 8, /*RST=*/ 9); // arbitrary selection of 8, 9 selected for default of GxEPD_Class
GxEPD_Class display(io, /*RST=*/ 9, /*BUSY=*/ 7); // default selection of (9), 7

#endif

#define FactorSeconds 1000000LL

AsyncClient client;

int counter;
char* serverUrl = "172.16.1.60";
char* dataPath = "/static/outputs/content.txt";

int touchPinLeft = 2;
int touchPinRight = 27;
int touchPinBottom = 13;
int touchValueLeft = 100;
int touchValueBottom = 100;
int touchValueRight = 100;

int clockWebUpdate = 60000;
int baseClock = 0;

String displayValue = "0;";
int lengthPixel = 0;
boolean loadedAll = false;

boolean showScreensaver = false;
String screensaver = "14965;7;90;7;536;7;90;7;135;14;28;12;65;12;39;21;16;7;4;40;25;7;21;7;83;7;90;7;131;20;24;16;23;12;26;16;37;24;13;7;4;40;25;7;21;7;83;7;66;7;17;7;129;23;21;19;17;17;24;20;35;25;12;7;4;40;25;7;21;7;83;7;66;7;17;7;128;26;18;21;15;18;23;22;34;26;11;7;4;40;25;7;21;7;83;7;66;7;17;7;128;27;16;23;14;18;22;24;33;27;10;7;4;40;25;7;21;7;83;7;66;7;17;7;128;27;16;24;13;18;21;25;33;7;7;14;9;7;20;8;41;7;21;7;83;7;66;7;17;7;128;8;10;10;14;9;7;9;13;18;21;9;8;9;32;7;11;10;9;7;20;8;41;7;21;7;83;7;66;7;17;7;128;5;15;9;13;8;10;8;12;6;5;7;20;9;10;9;31;7;13;9;8;7;20;8;41;7;21;7;83;7;66;7;17;7;128;3;18;8;12;8;11;8;23;7;20;8;12;8;31;7;14;8;8;7;20;8;41;7;21;7;83;7;66;7;17;7;149;8;12;7;13;8;22;7;19;8;14;7;31;7;14;8;8;7;20;8;41;7;21;7;83;7;66;7;17;7;150;7;11;8;14;7;22;7;19;8;14;8;30;7;15;8;7;7;20;8;41;7;21;7;17;13;28;12;13;7;34;13;19;7;17;7;5;11;24;12;30;11;57;7;11;7;15;7;22;7;19;7;16;7;30;7;15;8;7;7;20;8;41;7;21;7;14;19;22;18;10;7;14;9;8;19;12;22;6;7;3;15;20;16;16;7;3;15;55;7;11;7;15;8;21;7;19;7;16;7;30;7;15;8;7;7;20;8;41;7;21;7;12;22;20;21;8;7;13;9;7;22;11;22;6;7;1;18;17;20;14;7;1;18;54;7;11;7;16;7;21;7;18;8;16;8;29;7;15;8;7;7;20;8;41;7;21;7;12;23;17;23;8;7;12;9;8;23;10;22;6;27;15;22;13;27;53;7;10;8;16;7;21;7;18;8;16;8;29;7;15;8;7;7;20;8;41;7;21;7;12;24;15;24;8;7;11;9;9;24;9;22;6;27;14;24;12;27;53;7;10;7;17;7;21;7;18;8;16;8;29;7;15;8;7;7;20;8;41;7;21;7;12;24;15;24;8;7;10;9;10;24;9;22;6;28;12;26;11;28;52;7;10;7;17;7;21;7;18;8;16;8;29;7;15;8;7;7;20;8;41;7;21;7;12;5;11;9;13;10;10;5;8;7;9;9;11;5;11;9;12;7;17;12;8;8;12;9;8;9;11;12;8;8;51;8;10;7;17;8;20;7;19;7;16;8;29;7;14;8;8;7;20;8;41;7;21;7;12;3;15;7;12;9;14;3;8;7;8;9;12;3;15;7;12;7;17;10;11;8;10;9;10;9;10;10;11;8;50;7;11;7;17;8;20;7;19;7;16;8;29;7;14;8;8;7;20;8;41;35;31;7;11;8;26;7;6;9;33;7;11;7;17;9;13;7;10;8;12;8;10;9;13;7;49;8;11;7;18;7;20;7;19;7;16;8;29;7;13;9;8;7;20;8;41;35;31;7;10;8;27;7;5;9;34;7;11;7;17;8;14;7;9;8;14;8;9;8;14;7;48;8;12;7;18;7;20;7;19;8;14;10;28;7;11;10;9;7;20;8;41;35;32;6;10;8;27;7;4;9;36;6;11;7;17;8;14;7;9;7;16;7;9;8;14;7;47;9;12;7;18;7;20;7;19;8;14;10;28;7;7;14;9;7;20;8;41;35;32;6;10;7;28;7;3;9;37;6;11;7;17;7;16;6;9;7;16;7;9;7;16;6;47;8;13;7;18;7;20;7;19;9;12;11;28;27;10;7;20;8;41;35;32;7;8;8;28;7;2;9;38;7;10;7;17;7;16;6;8;8;16;8;8;7;16;6;46;8;14;7;18;7;20;7;20;9;10;12;28;26;11;7;20;8;41;7;21;7;32;7;8;7;29;7;1;9;39;7;10;7;17;7;16;6;8;7;18;7;8;7;16;6;45;9;14;7;18;7;20;7;20;10;8;13;28;25;12;7;20;8;41;7;21;7;17;22;8;7;29;16;25;22;10;7;17;7;16;7;7;7;18;7;8;7;16;7;43;9;15;7;18;7;20;7;21;30;28;24;13;7;20;8;41;7;21;7;15;24;8;7;29;15;24;24;10;7;17;7;16;7;7;7;18;7;8;7;16;7;42;9;16;7;18;7;20;7;22;28;29;21;16;7;20;8;41;7;21;7;13;26;8;7;29;13;24;26;10;7;17;7;16;7;7;7;18;7;8;7;16;7;41;9;17;7;18;7;20;7;23;27;29;7;30;7;20;8;41;7;21;7;12;27;8;7;29;13;23;27;10;7;17;7;16;7;7;7;18;7;8;7;16;7;40;9;18;7;17;8;20;7;24;18;1;7;29;7;30;7;20;8;41;7;21;7;11;28;8;7;29;15;20;28;10;7;17;7;16;7;7;7;18;7;8;7;16;7;39;9;19;7;17;8;20;7;25;16;2;7;29;7;30;7;20;8;41;7;21;7;11;16;5;7;8;7;29;16;19;16;5;7;10;7;17;7;16;7;7;7;18;7;8;7;16;7;38;9;20;7;17;7;21;7;27;12;4;7;29;7;30;7;20;8;41;7;21;7;10;9;13;7;8;7;29;7;1;9;17;9;13;7;10;7;17;7;16;7;7;7;18;7;8;7;16;7;37;9;21;7;17;7;21;7;43;7;29;7;30;7;20;8;41;7;21;7;10;7;15;7;8;7;29;7;2;9;16;7;15;7;10;7;17;7;16;7;7;7;18;7;8;7;16;7;36;9;22;8;16;7;21;7;42;8;29;7;30;7;20;8;41;7;21;7;9;8;15;7;8;7;29;7;3;9;14;8;15;7;10;7;17;7;16;7;7;7;18;7;8;7;16;7;35;9;24;7;16;7;21;7;42;7;30;7;30;7;20;8;41;7;21;7;9;7;16;7;8;8;28;7;4;9;13;7;16;7;10;7;17;7;16;7;7;8;16;8;8;7;16;7;34;9;25;7;15;8;21;7;42;7;30;7;30;7;20;8;41;7;21;7;9;7;15;8;9;7;28;7;5;9;12;7;15;8;10;7;17;7;16;7;8;7;16;7;9;7;16;7;33;9;26;7;15;7;22;7;41;8;30;7;30;7;20;8;41;7;21;7;9;7;15;8;9;8;27;7;6;9;11;7;15;8;10;7;17;7;16;7;8;7;16;7;9;7;16;7;32;9;27;8;14;7;22;7;41;7;31;7;30;7;20;8;41;7;21;7;9;7;14;9;9;8;27;7;7;9;10;7;14;9;10;7;17;7;16;7;8;8;14;8;9;7;16;7;31;9;29;7;13;8;22;7;40;8;31;7;30;7;20;8;41;7;21;7;9;7;14;9;10;8;26;7;8;9;9;7;14;9;11;6;17;7;16;7;9;8;12;8;10;7;16;7;30;9;30;8;11;8;23;7;39;8;32;7;30;7;20;8;41;7;21;7;10;7;12;10;10;9;14;3;8;7;9;9;9;7;12;10;11;7;16;7;16;7;9;9;10;9;10;7;16;7;29;9;32;8;10;8;23;7;21;3;14;9;32;7;30;7;20;8;41;7;21;7;10;8;9;12;11;10;10;5;8;7;10;9;8;8;9;12;11;11;12;7;16;7;10;9;8;9;11;7;16;7;28;9;33;9;7;9;24;7;21;5;10;10;33;7;30;7;20;8;41;7;21;7;10;29;12;24;8;7;11;9;7;29;11;17;6;7;16;7;10;26;11;7;16;7;28;30;13;24;14;27;11;24;34;7;30;7;20;8;41;7;21;7;11;28;12;24;8;7;12;9;7;28;12;16;6;7;16;7;11;24;12;7;16;7;28;30;13;23;15;27;11;23;35;7;30;7;20;8;41;7;21;7;11;28;13;23;8;7;13;9;6;28;12;16;6;7;16;7;12;22;13;7;16;7;28;30;14;21;16;27;11;22;36;7;30;7;20;8;41;7;21;7;12;19;1;7;15;21;8;7;14;9;6;19;1;7;13;15;6;7;16;7;13;20;14;7;16;7;28;30;15;19;17;27;11;21;37;7;30;7;20;8;41;7;21;7;14;15;3;7;16;18;10;7;15;9;7;15;3;7;15;13;6;7;16;7;15;16;16;7;16;7;28;30;17;16;18;27;12;18;202;12;31;12;52;12;93;12;125;12;62;13;5787;3200;4947;8;630;12;627;14;626;15;624;16;624;17;622;18;622;18;622;18;622;18;622;18;622;18;623;16;625;15;625;15;625;14;629;11;630;11;635;5;635;6;634;7;634;6;634;7;634;6;376;14;244;7;373;16;245;6;295;9;68;17;246;6;47;4;243;9;67;18;246;7;44;8;241;9;66;19;247;6;43;10;240;9;65;20;247;7;40;14;238;9;65;13;255;6;40;15;237;9;65;9;260;6;38;16;237;9;64;9;261;7;36;17;237;9;64;8;263;6;36;18;236;9;64;8;263;7;35;18;236;9;64;8;264;6;34;19;236;9;64;8;265;6;33;19;236;9;64;8;265;7;33;18;236;9;64;8;266;6;33;17;237;9;29;12;23;8;28;14;224;7;33;16;237;9;14;8;5;16;14;27;13;19;223;6;34;15;237;9;14;8;3;20;12;27;12;22;221;7;32;15;238;9;14;8;2;22;11;27;10;26;220;6;31;15;239;9;14;8;1;24;10;27;9;28;145;5;70;6;29;15;240;9;14;33;10;27;8;30;142;8;70;6;28;6;2;4;243;9;14;34;16;8;19;31;141;11;68;6;27;7;249;9;14;14;10;10;16;8;19;11;9;12;138;14;67;7;25;7;250;9;14;13;12;10;15;8;18;11;12;11;137;15;67;6;25;6;251;9;14;12;14;9;15;8;17;11;14;10;136;16;68;6;23;6;252;9;14;11;16;8;15;8;17;10;16;10;135;17;67;7;21;7;252;9;14;10;17;9;14;8;17;9;18;9;135;17;68;6;7;8;6;6;253;9;14;9;18;9;14;8;16;9;19;10;134;17;3;1;64;7;1;25;253;9;14;9;19;8;14;8;16;9;20;9;134;19;67;31;55;5;194;9;14;8;20;8;14;8;16;9;20;9;134;22;1;3;61;29;53;10;192;9;14;8;20;8;14;8;15;9;22;8;134;29;58;29;52;13;190;9;14;8;20;8;14;8;15;9;22;8;134;33;54;30;50;14;190;9;14;8;20;8;14;8;15;9;22;9;133;39;46;33;48;16;189;9;14;8;20;8;14;8;15;9;22;9;133;43;41;35;47;17;188;9;14;8;20;8;14;8;15;8;23;9;134;14;7;28;34;36;46;17;188;9;14;8;20;8;14;8;15;8;23;9;135;12;11;29;28;39;45;17;188;9;14;8;20;8;14;8;15;8;23;9;137;8;17;27;26;39;41;21;188;9;14;8;20;8;14;8;15;8;24;8;139;4;26;27;18;41;31;30;188;9;14;8;20;8;14;8;15;8;23;9;173;27;13;43;25;35;188;9;14;8;20;8;14;8;15;8;23;9;179;28;6;44;14;45;188;9;14;8;20;8;14;8;15;8;23;9;183;28;2;44;8;51;188;9;14;8;20;8;14;8;15;8;23;9;186;49;1;21;4;54;189;9;14;8;20;8;14;8;15;9;22;9;193;38;7;51;11;15;189;9;14;8;20;8;14;8;15;9;22;8;197;34;10;45;16;13;190;9;14;8;20;8;14;8;15;9;22;8;204;25;14;32;28;10;192;9;14;8;20;8;14;8;16;9;20;9;208;21;14;28;34;7;193;9;14;8;20;8;14;8;16;9;20;9;212;16;16;17;1;4;239;9;14;8;20;8;14;8;16;9;19;10;212;16;17;15;245;9;14;8;20;8;14;8;17;9;18;9;213;15;18;15;245;9;14;8;20;8;14;8;17;10;16;10;213;15;18;15;245;9;14;8;20;8;14;8;17;11;14;10;214;15;19;14;245;9;14;8;20;8;14;8;18;11;12;11;214;15;18;15;245;9;14;8;20;8;14;8;19;11;9;12;215;15;18;15;245;9;14;8;20;8;14;8;19;31;216;15;18;15;245;9;14;8;20;8;14;8;20;30;216;15;18;15;245;9;14;8;20;8;14;8;21;28;217;16;16;15;246;9;14;8;20;8;14;8;22;26;219;15;15;16;246;9;14;8;20;8;14;8;24;22;221;16;14;16;246;9;14;8;20;8;14;8;25;19;223;17;11;17;356;14;225;19;7;19;594;46;593;46;592;47;592;48;590;49;591;9;2;37;590;9;5;37;588;9;7;37;586;9;7;39;583;9;9;32;1;7;581;9;10;31;2;7;580;8;11;6;3;21;6;6;577;9;11;7;4;21;5;7;575;9;12;6;7;19;6;7;572;10;12;6;11;6;4;6;7;7;570;9;14;6;11;6;5;5;8;7;568;9;14;6;12;6;5;6;8;6;556;9;1;10;14;7;12;6;5;6;9;7;553;19;16;6;13;6;6;6;8;7;552;19;17;6;13;6;6;6;9;7;550;19;17;6;14;6;6;6;10;7;549;17;18;7;14;6;7;5;11;7;547;17;19;6;15;6;7;6;11;7;546;18;18;6;15;6;7;6;11;8;545;18;17;6;16;6;8;6;11;8;544;18;16;6;17;6;8;6;12;8;543;18;16;6;17;6;8;9;10;8;542;18;15;7;17;6;9;11;8;7;542;18;15;6;18;6;8;13;8;7;542;16;15;6;19;6;7;15;8;7;541;15;16;6;19;6;6;16;8;8;541;14;15;6;20;6;6;16;10;7;217;8;105;8;203;12;15;7;20;6;5;18;10;6;217;8;105;8;204;10;16;6;21;5;6;18;10;7;156;28;32;8;105;8;208;1;21;5;22;5;6;18;11;7;155;32;28;8;105;8;229;6;22;5;6;18;12;7;154;35;25;8;105;8;228;7;22;5;6;18;13;7;153;37;23;8;105;8;228;6;23;5;6;18;14;7;152;39;21;8;105;8;228;5;24;5;7;17;15;6;152;40;20;8;105;8;227;6;23;6;8;15;16;8;150;9;9;23;19;8;105;8;226;7;23;6;8;15;17;8;149;9;17;16;131;8;226;6;24;6;9;12;20;7;149;9;20;14;130;8;225;6;25;6;10;10;22;8;147;9;22;13;129;8;225;6;25;6;12;7;24;7;147;9;24;12;128;8;224;7;25;6;44;7;146;9;25;11;128;8;223;7;26;6;44;8;145;9;26;11;127;8;223;6;27;6;46;7;144;9;27;10;42;18;32;12;23;8;22;15;186;6;27;6;46;8;143;9;28;10;13;8;18;24;13;8;4;17;21;8;19;21;17;9;25;8;123;6;28;6;48;6;143;9;28;10;13;8;16;26;13;8;3;19;20;8;17;24;16;9;24;9;122;7;28;6;48;7;142;9;29;9;13;8;15;27;13;8;2;22;18;8;14;29;15;8;24;8;123;6;29;6;49;7;141;9;29;10;12;8;14;28;13;8;1;24;17;8;14;30;14;9;22;9;123;5;30;6;50;7;140;9;29;10;12;8;13;29;13;34;16;8;14;31;14;8;22;9;122;6;30;6;51;7;139;9;30;9;12;8;12;30;13;34;16;8;14;31;14;9;21;8;122;7;30;6;52;6;3;4;132;9;30;9;12;8;12;10;14;6;13;15;8;12;15;8;14;8;12;12;13;9;20;9;122;6;31;6;53;16;128;9;30;9;12;8;12;9;18;3;13;13;12;11;14;8;14;5;17;10;14;8;20;8;122;7;31;6;53;17;127;9;30;10;11;8;11;9;35;12;14;10;14;8;14;3;20;10;13;9;18;9;122;6;32;6;54;17;126;9;31;9;11;8;11;8;36;11;16;10;13;8;38;9;14;8;18;9;121;6;33;6;55;16;126;9;31;9;11;8;11;8;36;10;18;9;13;8;39;8;14;9;17;8;121;7;33;6;55;17;125;9;31;9;11;8;11;8;36;10;18;9;13;8;39;9;13;9;16;9;121;7;33;6;55;17;125;9;31;9;11;8;11;8;36;9;20;9;12;8;40;8;14;8;16;8;122;6;34;6;55;18;124;9;31;9;11;8;11;8;36;9;20;9;12;8;40;8;14;9;14;9;121;6;35;6;54;19;124;9;31;9;11;8;11;9;35;9;21;8;12;8;40;8;15;8;14;9;120;6;36;6;54;19;124;9;31;9;11;8;12;10;33;8;22;8;12;8;40;8;15;9;13;8;121;6;36;6;55;18;124;9;31;9;11;8;12;13;30;8;22;8;12;8;22;26;15;9;12;9;120;7;36;6;55;18;124;9;31;9;11;8;12;17;26;8;22;9;11;8;19;29;16;8;12;8;121;6;37;6;55;17;125;9;31;9;11;8;13;20;22;8;22;9;11;8;17;31;16;9;10;9;121;5;38;6;56;15;126;9;31;9;11;8;14;22;19;8;22;9;11;8;16;32;17;8;10;9;120;6;38;6;56;15;126;9;30;10;11;8;15;23;17;8;22;9;11;8;15;33;17;8;10;8;120;7;38;5;58;13;127;9;30;9;12;8;16;24;15;8;22;9;11;8;14;19;7;8;17;9;8;9;120;6;39;5;60;10;128;9;30;9;12;8;18;23;14;8;22;9;11;8;13;12;15;8;18;8;8;8;120;6;40;5;60;8;130;9;30;9;12;8;21;21;13;8;22;9;11;8;13;9;18;8;18;9;6;9;120;6;40;5;198;9;29;10;12;8;25;18;12;8;22;9;11;8;12;9;19;8;19;8;6;9;119;6;41;5;198;9;29;10;12;8;29;14;12;8;22;9;11;8;12;8;20;8;19;8;6;8;119;7;41;5;198;9;29;9;13;8;32;12;11;8;22;8;12;8;12;8;20;8;20;8;4;9;119;6;42;5;198;9;28;10;13;8;34;10;11;8;22;8;12;8;11;8;21;8;20;8;4;8;120;6;42;5;198;9;28;10;13;8;35;9;11;9;21;8;12;8;11;8;20;9;20;9;2;9;119;6;43;5;198;9;27;10;14;8;36;8;11;9;20;9;12;8;11;8;20;9;21;8;2;9;118;7;43;5;198;9;26;11;14;8;36;8;11;9;20;9;12;8;11;8;20;9;21;8;2;8;119;6;44;5;198;9;25;11;15;8;36;8;11;10;18;9;13;8;11;8;19;10;22;17;118;7;44;5;198;9;24;12;15;8;36;8;11;10;18;9;13;8;11;9;17;11;22;16;119;6;45;5;198;9;22;13;16;8;36;8;11;11;16;10;13;8;11;9;17;11;22;16;118;7;45;5;198;9;20;14;17;8;11;3;21;9;11;12;14;10;14;8;12;9;15;12;23;15;117;8;45;5;198;9;17;16;18;8;11;5;18;10;11;13;12;11;14;8;12;10;12;14;23;14;118;6;47;5;198;9;9;23;19;8;11;8;13;11;12;15;8;12;15;8;12;11;10;15;24;13;118;6;47;5;198;40;20;8;11;32;12;34;16;8;13;35;24;12;118;6;48;5;198;38;22;8;11;31;13;34;16;8;13;35;24;12;117;7;48;5;198;37;23;8;11;30;14;8;1;24;17;8;14;25;1;8;25;11;117;7;48;5;198;35;25;8;11;29;15;8;2;22;18;8;15;23;2;8;25;10;118;6;49;5;198;32;28;8;11;28;16;8;3;19;20;8;16;21;3;8;26;9;117;6;50;5;198;28;32;8;14;23;18;8;4;17;21;8;17;18;5;8;26;8;117;7;50;5;284;16;21;8;7;12;51;13;40;9;117;6;51;5;321;8;123;9;117;6;51;5;321;8;123;8;113;10;52;5;321;8;122;9;110;12;53;5;321;8;122;8;110;13;53;5;321;8;121;9;109;15;52;5;321;8;121;9;109;16;51;5;321;8;120;9;109;17;51;5;321;8;119;10;109;18;49;6;321;8;115;13;109;19;47;10;319;8;111;17;109;19;46;12;318;8;111;16;110;19;45;14;317;8;111;15;112;18;45;14;317;8;111;14;113;18;44;16;316;8;111;13;114;17;44;18;315;8;111;11;117;16;44;18;562;15;45;18;563;13;46;18;564;11;47;18;565;8;49;18;622;18;623;16;625;14;626;14;627;12;630;8;22720;5;166;5;6;5;453;5;166;5;6;5;316;5;113;18;1;5;80;5;81;5;6;5;42;5;80;5;184;5;113;18;1;5;80;5;81;5;6;5;42;5;80;5;184;5;113;18;86;5;92;5;42;5;80;5;184;5;113;5;99;5;92;5;42;5;80;5;184;5;113;5;99;5;92;5;42;5;80;5;184;5;113;5;99;5;92;5;42;5;80;5;184;5;21;9;17;8;13;10;35;5;32;8;17;8;34;5;10;10;18;8;17;8;21;5;42;5;10;10;18;8;34;5;21;9;14;10;17;8;105;5;19;13;8;17;9;14;33;5;14;5;6;17;8;17;32;5;8;14;9;17;8;17;8;5;6;5;8;6;28;5;8;14;9;17;32;5;19;13;10;13;9;17;103;5;18;15;7;17;8;16;32;5;14;5;6;17;8;17;32;5;7;16;8;17;8;17;8;5;6;5;7;6;29;5;7;16;8;17;32;5;18;15;8;16;7;17;103;5;17;17;6;18;7;16;32;5;14;5;6;18;7;18;31;5;7;16;8;18;7;18;7;5;6;5;6;6;30;5;7;16;8;18;31;5;17;17;7;16;7;18;102;5;16;6;7;5;6;7;6;5;7;3;8;6;31;5;14;5;6;7;6;5;7;7;6;5;31;5;7;3;8;6;7;7;6;5;7;7;6;5;7;5;6;5;5;6;31;5;7;3;8;6;7;7;6;5;31;5;16;6;7;5;6;6;6;6;6;7;6;5;102;5;16;5;9;5;5;6;8;5;18;5;31;16;3;5;6;6;8;5;6;6;8;5;30;5;19;5;7;6;8;5;6;6;8;5;6;5;6;5;3;7;32;5;19;5;7;6;8;5;30;5;16;5;9;5;5;5;8;5;6;6;8;5;101;5;15;5;10;5;5;5;9;5;19;4;31;16;3;5;6;5;9;5;6;5;9;5;30;5;20;4;7;5;9;5;6;5;9;5;6;5;6;5;2;7;33;5;20;4;7;5;9;5;30;5;15;5;10;5;4;5;9;6;5;5;9;5;101;5;15;5;11;4;5;5;9;5;19;5;30;16;3;5;6;5;9;5;6;5;9;5;30;5;20;5;6;5;9;5;6;5;9;5;6;5;6;5;1;6;35;5;20;5;6;5;9;5;30;5;15;5;11;4;4;5;10;5;5;5;9;5;101;5;15;5;11;4;5;5;9;5;19;5;30;5;14;5;6;5;9;5;6;5;9;5;30;5;20;5;6;5;9;5;6;5;9;5;6;5;6;11;36;5;20;5;6;5;9;5;30;5;15;5;11;4;4;5;10;5;5;5;9;5;101;5;15;20;5;5;9;5;9;15;30;5;14;5;6;5;9;5;6;5;9;5;30;5;10;15;6;5;9;5;6;5;9;5;6;5;6;10;37;5;10;15;6;5;9;5;30;5;15;20;4;4;11;5;5;5;9;5;101;5;15;20;5;5;9;5;7;17;30;5;14;5;6;5;9;5;6;5;9;5;30;5;8;17;6;5;9;5;6;5;9;5;6;5;6;9;38;5;8;17;6;5;9;5;30;5;15;20;4;4;11;5;5;5;9;5;101;5;15;20;5;5;9;5;6;18;30;5;14;5;6;5;9;5;6;5;9;5;30;5;7;18;6;5;9;5;6;5;9;5;6;5;6;9;38;5;7;18;6;5;9;5;30;5;15;20;4;4;11;5;5;5;9;5;101;5;15;4;21;5;9;5;5;11;3;5;30;5;14;5;6;5;9;5;6;5;9;5;30;5;6;11;3;5;6;5;9;5;6;5;9;5;6;5;6;10;37;5;6;11;3;5;6;5;9;5;30;5;15;4;20;4;11;5;5;5;9;5;101;5;15;5;20;5;9;5;5;6;8;5;30;5;14;5;6;5;9;5;6;5;9;5;30;5;6;6;8;5;6;5;9;5;6;5;9;5;6;5;6;11;36;5;6;6;8;5;6;5;9;5;30;5;15;5;19;5;10;5;5;5;9;5;101;5;15;5;20;5;9;5;5;5;9;5;30;5;14;5;6;5;9;5;6;5;9;5;30;5;6;5;9;5;6;5;9;5;6;5;9;5;6;5;6;5;1;6;35;5;6;5;9;5;6;5;9;5;30;5;15;5;19;5;10;5;5;5;9;5;101;5;15;5;20;5;9;5;5;4;10;5;30;5;14;5;6;5;9;5;6;5;9;5;30;5;6;4;10;5;6;5;9;5;6;5;9;5;6;5;6;5;2;7;33;5;6;4;10;5;6;5;9;5;30;5;15;5;19;5;9;6;5;5;9;5;101;5;16;5;19;5;9;5;5;5;8;6;30;5;14;5;6;5;9;5;6;5;9;5;30;5;6;5;8;6;6;5;9;5;6;5;9;5;6;5;6;5;3;7;32;5;6;5;8;6;6;5;9;5;30;5;16;5;19;5;8;5;6;5;9;5;101;5;16;6;10;3;5;5;9;5;5;5;7;7;7;5;18;5;14;5;6;5;9;5;6;5;9;5;7;5;18;5;6;5;7;7;6;5;9;5;6;5;9;5;6;5;6;5;4;7;8;5;18;5;6;5;7;7;6;5;9;5;7;5;18;5;16;6;10;3;5;6;6;6;6;5;9;5;101;5;17;18;5;5;9;5;5;19;7;5;18;5;14;5;6;5;9;5;6;5;9;5;7;5;18;5;6;19;6;5;9;5;6;5;9;5;6;5;6;5;5;7;7;5;18;5;6;19;6;5;9;5;7;5;18;5;17;18;6;16;7;5;9;5;101;19;4;17;5;5;9;5;6;18;7;5;18;5;14;5;6;5;9;5;6;5;9;5;7;5;18;5;7;18;6;5;9;5;6;5;9;5;6;5;6;5;6;7;6;5;18;5;7;18;6;5;9;5;7;5;18;19;4;17;6;16;7;5;9;5;101;19;5;15;6;5;9;5;7;17;7;5;18;5;14;5;6;5;9;5;6;5;9;5;7;5;18;5;8;17;6;5;9;5;6;5;9;5;6;5;6;5;7;7;5;5;18;5;8;17;6;5;9;5;7;5;18;19;5;15;8;13;9;5;9;5;101;19;7;11;8;5;9;5;8;9;2;5;7;5;18;5;14;5;6;5;9;5;6;5;9;5;7;5;18;5;9;9;2;5;6;5;9;5;6;5;9;5;6;5;6;5;8;7;4;5;18;5;9;9;2;5;6;5;9;5;7;5;18;19;7;11;12;10;10;5;9;5;195;5;99;5;19;5;115;5;19;5;56;5;302;4;100;4;20;5;115;4;20;5;56;4;303;4;100;4;20;5;115;4;20;5;56;4;303;3;101;3;20;6;115;3;20;6;56;3;428;8;136;8;486;10;134;10;486;9;135;9;487;7;137;7;11740;";

void setup() {
  Serial.begin(115200);
  display.init(); // enable diagnostic output on Serial

  WiFi.begin("Forum", "Hack2019");
  while(WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println("Started");
  counter = 0;

  client.setRxTimeout(10);            // 5 sec timeout
  client.onConnect(&onConnectHandler);
  client.onData(&onDataHandler);
  client.onDisconnect(&onDisconnectHandler);
  client.onTimeout(&onTimeoutHandler);
  client.onError(&onErrorHandler);
}

void loop() {
  touchValueLeft = touchRead(touchPinLeft);
  if(touchValueLeft < 50 && touchValueLeft != 0) {
    Serial.println(String("Left Below 50: ") + touchValueLeft);
    if(showScreensaver == true) {
      drawNews();
    }
    showScreensaver = false;
  }
  touchValueRight = touchRead(touchPinRight);
  if(touchValueRight < 50 && touchValueRight != 0) {
    Serial.println(String("Right Below 50: ") + touchValueRight);
    if(showScreensaver == false) {
      drawScreensaver();
    }
    showScreensaver = true;
  }
  touchValueBottom = touchRead(touchPinBottom);
  if(touchValueBottom < 50 && touchValueBottom != 0) {
    Serial.println(String("Bottom Below 50: ") + touchValueBottom);
  }

  if(showScreensaver == false) {
    if( (baseClock % clockWebUpdate) == 0) {
      drawNews();
    }
  }

  baseClock = baseClock + 500;
  delay(500);
}

void drawScreensaver() {
  drawBlackPixelOld(screensaver);
}

void drawNews() {
  connectToRaspi();
  while(!loadedAll) {
    delay(500);
    baseClock += 500;
  }
  drawBlackPixelOld(displayValue);
}

void connectToRaspi() {
  if (WiFi.status() == WL_CONNECTED) {
      const int httpPort = 5000;
      const char* host = serverUrl;

      if (!client.connect(host, httpPort)) {
        Serial.println("connection failed");
      } else {
        Serial.println("Wait till the client is connected");
      }
    } else {
      Serial.println("WLAN not conntected");
    }
}

/* - - - - AsyncClient Handler - - - - - - - */
void onConnectHandler(void *r, AsyncClient *client){
  Serial.println("OnConnect\n");

  String query = String("GET ") + dataPath + " HTTP/1.1\r\n" +
                 "Host: " + serverUrl + "\r\n" +
                 "Connection: close\r\n\r\n";
  client->write(query.c_str());
}

void onDataHandler(void *r, AsyncClient *client, void *data, size_t len){
  String text = String((char*) data);
  Serial.println(String("New data: ") + text.length() + "; Len: " + len);
  text = text.substring(0, len);
  int indexContentStart = text.indexOf("Lorem");
  if(indexContentStart != -1) {
    displayValue = "";
    loadedAll = false;
    text = text.substring(indexContentStart + 5);
  }
  int indexContentEnd = text.indexOf("ipsum");
  if(indexContentEnd != -1) {
    loadedAll = true;
    text = text.substring(0, indexContentEnd);
    Serial.println(displayValue + text);
  }
  if(!text.startsWith("HTTP")) {
    displayValue += text;
  } else {
    Serial.println(text);
  }
}

void onTimeoutHandler(void *r, AsyncClient *client, uint32_t timeout){
  Serial.println(String("Timeout ") + timeout);
}

void onDisconnectHandler(void *r, AsyncClient *client){
  Serial.println("OnDisconnect");
}

/*
void drawBlackPixelSimple() {
  Serial.println("black pixel simple");
  display.fillScreen(GxEPD_WHITE);
  for(int i = 0; i < 300; i += 1 ) {
    display.drawPixel(i, 1, GxEPD_BLACK);
  }
  display.update();
}*/

void drawBlackPixelOld(String dataLeft) {
  int x = 0;
  int y = 0;
  boolean isBlack = false;
  int pixelCounter = 0;
  String currentCounter = "";
  dataLeft.trim();

  Serial.println(String("Start draw black pixel old: ") + dataLeft.length());
  
  display.fillScreen(GxEPD_WHITE);
  display.setCursor(0,0);
  
  while(dataLeft.length() > 0) {
    int indexNextValue = dataLeft.indexOf(";");
    
    if(indexNextValue < dataLeft.length()) {
      currentCounter = dataLeft.substring(0, indexNextValue);
      pixelCounter = currentCounter.toInt();
      dataLeft = dataLeft.substring(indexNextValue + 1);
        for(int i = 0; i < pixelCounter; i++) {
          if(isBlack == true) {
            display.drawPixel(x, y, GxEPD_BLACK);
          }
          x++;
          if(x == 640) {
            y++;
            x = 0;
          }
        }
        isBlack = !isBlack;
      }
  }
  display.update();
  Serial.println("Updated screen");
}

void onErrorHandler(void *r, AsyncClient *client, int8_t error){
  Serial.println(String("Error:") + error);
}
